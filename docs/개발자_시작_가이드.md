# Korea Credit Scoring System — 개발자 시작 가이드

## 목차
1. [시스템 개요](#1-시스템-개요)
2. [사전 요구사항](#2-사전-요구사항)
3. [빠른 시작](#3-빠른-시작)
4. [개발 환경 구성](#4-개발-환경-구성)
5. [ML 파이프라인 실행](#5-ml-파이프라인-실행)
6. [테스트 실행](#6-테스트-실행)
7. [API 엔드포인트 요약](#7-api-엔드포인트-요약)
8. [아키텍처 개요](#8-아키텍처-개요)
9. [규제 파라미터 관리](#9-규제-파라미터-관리)
10. [트러블슈팅](#10-트러블슈팅)

---

## 1. 시스템 개요

**Korea Credit Scoring System (KCS)**은 개인 및 개인사업자 대상 비대면 신용평가 시스템입니다.

### 핵심 특징
| 항목 | 내용 |
|------|------|
| 대상 | 개인(직장인/자영업자) + 개인사업자 |
| 채널 | 비대면 디지털 (카카오/네이버/앱) |
| 규제 | 금감원 모범규준, 바젤III IRB, 금소법, 신용정보법 |
| 스코어 범위 | 300~900 (기준점 600 = PD 7.2%) |
| 외부 API | NICE CB, KCB, 국세청, 건보, MyData, 전문직면허 |

### 지원 상품
- `credit`: 신용대출 (개인)
- `mortgage`: 주택담보대출
- `micro`: 소액마이크로론 (3천만원 이하)
- `credit_soho`: 개인사업자 신용대출

---

## 2. 사전 요구사항

```bash
# 필수
Docker >= 24.0
Docker Compose >= 2.20
Python >= 3.11 (로컬 ML 학습용)

# 선택
make (Makefile 사용)
curl (데모 스크립트)
```

---

## 3. 빠른 시작

```bash
# 1. 저장소 클론
git clone <repo-url>
cd korea-credit-scoring

# 2. 환경변수 설정
cp backend/.env.example backend/.env

# 3. 전체 스택 기동 (API + Mock Server + DB + Redis)
make up

# 4. 서버 확인
curl http://localhost:8000/health
# → {"status":"ok","service":"kcs-api","version":"1.1.0"}

# 5. Swagger UI 접속
open http://localhost:8000/docs
```

> **첫 기동 시**: `main.py`의 lifespan이 자동으로 DB 테이블 생성 + 규제 파라미터 30개 시드를 실행합니다.

---

## 4. 개발 환경 구성

### 4.1 서비스 구성

| 서비스 | 포트 | 설명 |
|--------|------|------|
| API | 8000 | FastAPI 메인 서버 (Swagger: `/docs`) |
| Mock Server | 8001 | 외부 API 시뮬레이터 (CB/국세청/건보) |
| PostgreSQL | 5432 | 메인 DB (`kcs_db`) |
| Redis | 6379 | BRMS 캐시 (TTL 5분) |
| pgAdmin | 5050 | DB 관리 (`make up-tools`) |
| MLflow | 5001 | 모델 레지스트리 (`make up-ml`) |
| Kafka | 9092 | EWS 이벤트 스트리밍 (`make up-kafka`) |

### 4.2 선택적 프로필 실행

```bash
make up           # 기본 (API + Mock + DB + Redis)
make up-tools     # + pgAdmin
make up-ml        # + MLflow
make up-kafka     # + Kafka/Zookeeper
```

### 4.3 볼륨 마운트

```
backend/         → /app        (핫리로드)
ml_pipeline/artifacts/ → /app/artifacts (모델 파일)
```

### 4.4 개발 시 코드 변경 반영

개발 환경에서는 `--reload` 옵션이 활성화되어 있어 코드 변경이 즉시 반영됩니다.

---

## 5. ML 파이프라인 실행

### 5.1 전체 파이프라인

```bash
# 합성 데이터 생성 (13.5만건) → 3개 모델 학습 → 성능 검증
make gen-synthetic  # 합성 데이터 생성
make train          # 모든 모델 학습

# 또는 한번에
python ml_pipeline/run_pipeline.py
```

### 5.2 개별 모델 학습

```bash
# Application Scorecard (신청평점, LightGBM)
python ml_pipeline/training/train_application.py

# Behavioral Scorecard (행동평점, XGBoost)
python ml_pipeline/training/train_behavioral.py

# Collection Scorecard (추심평점, RandomForest)
python ml_pipeline/training/train_collection.py
```

### 5.3 모델 성능 기준 (금감원 모범규준)

| 스코어카드 | OOT Gini 기준 | OOT KS 기준 |
|-----------|-------------|------------|
| Application | ≥ 0.30 | ≥ 0.20 |
| Behavioral | ≥ 0.25 | ≥ 0.15 |
| Collection | ≥ 0.20 | ≥ 0.15 |

### 5.4 아티팩트 경로

```
ml_pipeline/artifacts/
├── application/
│   ├── application_scorecard.pkl (또는 .lgb)
│   ├── feature_names.json
│   ├── shap_importance.csv
│   └── model_card.json
├── behavioral/
│   ├── behavioral_scorecard.xgb
│   ├── feature_names.json
│   └── model_card.json
└── collection/
    ├── collection_scorecard.pkl
    ├── feature_names.json
    └── model_card.json
```

### 5.5 MLflow 등록 (선택)

```bash
# MLflow 서버 기동
make up-ml

# 모델 등록
python ml_pipeline/registry/register_models.py \
    --mlflow-uri http://localhost:5001 \
    --promote Staging
```

---

## 6. 테스트 실행

### 6.1 테스트 종류

```bash
make test                # 전체 (단위 + 통합 + 검증)
make test-unit           # 단위 테스트 (scoring_engine, monitoring_engine)
make test-integration    # FastAPI E2E 테스트
make test-regulatory     # 규제 준수 (DSR/LTV/금리 한도)
make test-stress         # 스트레스 테스트 (금리/부동산/경기침체)
make test-fairness       # 공정성 테스트 (AI 모범규준 7대 원칙)
make test-model          # 모델 성능 테스트 (Gini/KS/RAROC)
make test-all-validation # 전체 검증 (validation/ 전체)
```

### 6.2 테스트 구조

```
tests/
├── unit/
│   ├── test_scoring_engine.py    # ScoringEngine 단위 테스트
│   └── test_monitoring_engine.py # PSI/ECE/Brier 단위 테스트
├── integration/
│   └── test_api_e2e.py           # FastAPI 전체 엔드포인트
└── regulatory/
    └── test_brms_params.py       # BRMS 파라미터 무결성

validation/roles/
├── developer/
│   ├── test_model_performance.py      # 모델 성능 (Gini/KS/AUC)
│   └── test_regulatory_compliance.py  # 규제 준수 (DSR/LTV/금리)
├── risk_management/
│   ├── test_regulatory_validation.py  # 규제 검증 (Basel/RAROC)
│   ├── test_risk_profitability.py     # 리스크/수익성
│   └── test_stress_scenarios.py       # 스트레스 시나리오
└── compliance/
    └── test_fairness.py               # AI 공정성 (7대 원칙)
```

---

## 7. API 엔드포인트 요약

### 7.1 비대면 신청 여정 (`/api/v1/applications`)

```
POST   /start              # Step 1: 신청 세션 시작
POST   /{id}/consent       # Step 2: CB 조회 동의
POST   /{id}/applicant     # Step 3: 신청인 기본정보
POST   /{id}/financial     # Step 4: 재무 정보 (외부 API)
POST   /{id}/product       # Step 5: 상품/한도 선택
POST   /{id}/submit        # Step 6: 최종 제출 → 자동 심사
GET    /{id}/result        # Step 7: 결과 조회
POST   /{id}/appeal        # 이의제기 (신용정보법 §39의5)
```

### 7.2 직접 평가 (`/api/v1/scoring`)

```
POST   /evaluate           # 직접 평가 (배치 스코어링)
GET    /score-scale        # 점수 스케일 정보
```

### 7.3 관리자 (`/api/v1/admin`)

```
GET    /regulation-params  # 규제 파라미터 목록
POST   /regulation-params  # 신규 등록 (4-eyes 승인)
PATCH  /regulation-params/{id}  # 수정
DELETE /regulation-params/{id}  # 비활성화
GET    /eq-grade-master    # EQ Grade 마스터
GET    /irg-master         # IRG 마스터
```

### 7.4 모니터링 (`/api/v1/monitoring`)

```
GET    /psi-summary        # PSI 요약 (점수/피처/타겟)
GET    /calibration        # 캘리브레이션 (ECE/Brier)
GET    /vintage            # 빈티지/코호트 분석
GET    /portfolio-summary  # 포트폴리오 요약
GET    /psi-report         # 통합 모니터링 보고서
```

### 7.5 평가 요청 예시

```bash
curl -X POST http://localhost:8000/api/v1/scoring/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "resident_hash": "test_hash_001",
    "product_type": "credit",
    "requested_amount": 30000000,
    "requested_term_months": 36,
    "cb_score": 720,
    "income_annual_wan": 4000,
    "delinquency_count_12m": 0,
    "employment_type": "employed",
    "employment_duration_months": 36,
    "existing_loan_monthly_payment": 200000,
    "open_loan_count": 1,
    "total_loan_balance": 3000000,
    "inquiry_count_3m": 1,
    "worst_delinquency_status": 0,
    "age": 32,
    "dsr_ratio": 0.15
  }'
```

---

## 8. 아키텍처 개요

### 8.1 점수 계산 흐름

```
신청 접수
    ↓
BRMS PolicyEngine (규제 파라미터 조회)
    ↓
CB API (NICE → KCB 폴백 → 기본값 700)
    ↓
ScoringInput 조립
    ↓
ScoringEngine (LightGBM 또는 통계 폴백)
    ↓
점수 변환 (PD → Score: 300~900, PDO=40)
    ↓
의사결정 (<450: 거절, 450-529: 수동심사, ≥530: 승인)
    ↓
RAROC 기반 금리 산출
    ↓
DB 저장 + 감사 로그
```

### 8.2 점수 스케일링 공식

```
Score = 600 - (40/ln2) × ln(PD / 0.072)

기준점: 600점 = PD 7.2%
PDO: 40 (PD 2배 → 점수 40점 하락)
범위: 300~900
```

### 8.3 BRMS 파라미터 조회 순서

```
Redis 캐시 (TTL 5분)
    ↓ (캐시 미스)
PostgreSQL regulation_params 테이블
    ↓ (DB 장애)
config.py 하드코딩 기본값
```

---

## 9. 규제 파라미터 관리

### 9.1 핵심 규제값 (2025.07.01 기준)

| 파라미터 | 값 | 법령 |
|---------|-----|------|
| DSR 한도 | 40% | 은행업감독규정 §35의5 |
| LTV 일반 | 70% | 주택담보대출업무처리기준 |
| LTV 조정지역 | 60% | 동상 |
| LTV 투기과열 | 40% | 동상 |
| 최고금리 | 20% | 이자제한법 §2 |
| 스트레스DSR Phase3 수도권 | 1.50%p | 금감원 행정지도 |
| 스트레스DSR Phase3 비수도권 | 3.00%p | 동상 |

### 9.2 규제 파라미터 변경 방법

```bash
# 1. API를 통한 변경 (4-eyes 원칙)
curl -X POST http://localhost:8000/api/v1/admin/regulation-params \
  -H "Content-Type: application/json" \
  -d '{
    "param_key": "dsr.max_ratio",
    "param_category": "dsr",
    "param_value": {"max_ratio": 0.45, "unit": "ratio"},
    "effective_from": "2026-01-01T00:00:00+09:00",
    "legal_basis": "은행업감독규정 §35의5 개정",
    "change_reason": "DSR 한도 45%로 완화",
    "created_by": "risk_manager_001",
    "approved_by": "chief_risk_officer_001"
  }'

# 2. Redis 캐시 즉시 갱신 (서버 재시작 없이)
docker compose exec redis redis-cli FLUSHDB
```

### 9.3 EQ Grade 혜택 체계

| 등급 | 한도 배수 | 금리 조정 | 대상 |
|------|---------|---------|------|
| EQ-S | 2.0× | -0.5%p | 대기업/공기업 |
| EQ-A | 1.8× | -0.3%p | 우량 중견기업 |
| EQ-B | 1.5× | -0.2%p | 일반 우량기업 |
| EQ-C | 1.2× | 0 | 기준 |
| EQ-D | 1.0× | +0.2%p | 주의 기업 |
| EQ-E | 0.7× | +0.5%p | 고위험 기업 |

### 9.4 특수 세그먼트

| 세그먼트 | 대상 | 혜택 |
|---------|------|------|
| SEG-DR | 의사/치과의사/한의사 | EQ-B 보장, 3.0× 한도, -0.3%p |
| SEG-JD | 변호사/법무사/회계사 | EQ-B 보장, 2.5× 한도, -0.2%p |
| SEG-ART | 예술인복지재단 등록 예술인 | 12개월 소득 평활화 |
| SEG-YTH | 만 19-34세 청년 | -0.5%p 금리우대 |
| SEG-MIL | 군인/공무원 | EQ-S 보장, 2.0× 한도, -0.5%p |
| SEG-MOU-{code} | 협약기업 근로자 | 협약별 맞춤 혜택 |

---

## 10. 트러블슈팅

### DB 연결 오류
```bash
# PostgreSQL 상태 확인
make status
docker compose logs db

# 수동 마이그레이션
make migrate
```

### 모델 파일 없을 때 동작
```
scoring_engine.py가 자동으로 통계 폴백 모드로 동작.
ml_pipeline/artifacts/ 에 모델 파일이 없어도 API는 정상 응답.
```

### Redis 캐시 초기화
```bash
docker compose exec redis redis-cli FLUSHALL
```

### 규제 파라미터 재시드
```bash
make seed-data
```

### 로그 확인
```bash
make logs          # API 서버 로그
make logs-all      # 전체 서비스 로그
```

### 데모 시나리오 실행
```bash
bash scripts/demo_api.sh
```

---

*마지막 업데이트: 2026-02-28*
*버전: v1.1.0*
